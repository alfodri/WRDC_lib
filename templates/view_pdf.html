{% extends "base.html" %}

{% block title %}{{ publication.title }} - WRDC Library{% endblock %}

{% block extra_css %}
<style>
    /* Reading environment background */
    .viewer-container {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        min-height: calc(100vh - 200px);
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
    }

    /* Professional Top Bar for PDF Controls */
    .viewer-toolbar {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .toolbar-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .btn-viewer {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.2);
        color: #ddd;
        padding: 8px 15px;
        border-radius: 6px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .btn-viewer:hover:not(:disabled) {
        background: rgba(255,255,255,0.15);
        color: white;
        border-color: rgba(255,255,255,0.3);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn-viewer:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .page-counter {
        font-size: 0.9rem;
        min-width: 100px;
        text-align: center;
    }

    /* Book Layout */
    #pdf-canvas-container {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 20px;
        gap: 8px;
        overflow-y: auto;
        background: linear-gradient(45deg, #8b4513 0%, #654321 100%);
        border-radius: 15px;
        box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
    }

    .pdf-page-canvas {
        background-color: white;
        box-shadow:
            0 15px 35px rgba(0,0,0,0.4),
            0 5px 15px rgba(0,0,0,0.2);
        max-width: 45%;
        height: auto;
        border-radius: 5px;
        transition: all 0.3s ease;
        position: relative;
    }

    .pdf-page-canvas:hover {
        transform: translateY(-2px);
        box-shadow:
            0 20px 40px rgba(0,0,0,0.5),
            0 8px 20px rgba(0,0,0,0.3);
    }

    /* Book spine effect */
    .pdf-page-canvas:nth-child(1) {
        transform: rotateY(-3deg);
    }

    .pdf-page-canvas:nth-child(2) {
        transform: rotateY(3deg);
    }

    /* Single page mode */
    #pdf-canvas-container.single-page .pdf-page-canvas {
        max-width: 70%;
        transform: none !important;
    }

    /* Scroll mode */
    #pdf-scroll-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }

    .pdf-scroll-pages {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .scroll-page-canvas {
        background-color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 800px;
        width: 100%;
        height: auto;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    /* Hide navigation controls in scroll mode */
    .viewer-toolbar.has-scroll-mode .toolbar-group:first-child {
        display: none;
    }

    /* Show scroll indicator in scroll mode */
    .viewer-toolbar.has-scroll-mode .toolbar-group:nth-child(2)::before {
        content: "Scroll Mode - ";
        font-weight: 500;
        color: #ddd;
        margin-right: 10px;
    }

    /* Metadata Sidebar/Section */
    .doc-info-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .author-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .authors-stack-viewer {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .author-avatar-viewer {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .author-name-viewer {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.25rem;
    }

    .author-info-viewer {
        flex: 1;
        min-width: 0;
    }

    @media (max-width: 991px) {
        #pdf-canvas-container {
            flex-direction: column;
            gap: 20px;
        }
        .pdf-page-canvas {
            max-width: 90% !important;
            transform: none !important;
        }
    }

    /* Book binding effect */
    #pdf-canvas-container::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 8px;
        background: linear-gradient(to bottom, #654321, #8b4513, #654321);
        transform: translateX(-50%);
        box-shadow: 0 0 20px rgba(0,0,0,0.3);
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 mb-5">
    <div class="row">
        <!-- Metadata Sidebar -->
        <div class="col-lg-3">
            <div class="doc-info-card">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb bg-transparent p-0 mb-3">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Library</a></li>
                        <li class="breadcrumb-item active">View Document</li>
                    </ol>
                </nav>
                
                <h2 class="h4 font-weight-bold mb-4 text-dark">{{ publication.title }}</h2>
                
                <div class="mb-4">
                    {% set authors_list = publication.get('authors_list', []) %}
                    {% if not authors_list and publication.get('author') %}
                        {% set authors_list = [publication.author] %}
                    {% endif %}
                    {% if authors_list %}
                        {% if authors_list|length == 1 %}
                            {# Single author - show large avatar #}
                            <div class="d-flex align-items-center mb-3">
                                {% if publication.get('author_images', {}).get(authors_list[0]) %}
                                <img src="{{ url_for('static', filename='uploads/authors/' + publication.author_images[authors_list[0]]) }}" 
                                     class="author-avatar-large mr-3" alt="{{ authors_list[0] }}">
                                {% else %}
                                <div class="author-avatar-large bg-light d-flex align-items-center justify-content-center mr-3">
                                    <i class="fas fa-user text-muted fa-2x"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <h6 class="mb-0 font-weight-bold">{{ authors_list[0] }}</h6>
                                    <small class="text-muted">Research Author</small>
                                </div>
                            </div>
                        {% else %}
                            {# Multiple authors - show stacked avatars #}
                            <div class="authors-stack-viewer">
                                {% for author_name in authors_list %}
                                    {% if publication.get('author_images', {}).get(author_name) %}
                                    <img src="{{ url_for('static', filename='uploads/authors/' + publication.author_images[author_name]) }}" 
                                         class="author-avatar-viewer" 
                                         alt="{{ author_name }}"
                                         title="{{ author_name }}">
                                    {% else %}
                                    <div class="author-avatar-viewer bg-light d-flex align-items-center justify-content-center" title="{{ author_name }}">
                                        <i class="fas fa-user text-muted"></i>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="author-info-viewer">
                                {% for author_name in authors_list %}
                                    <div class="author-name-viewer">{{ author_name }}</div>
                                {% endfor %}
                                <small class="text-muted">Research Authors</small>
                            </div>
                        {% endif %}
                    {% else %}
                        {# Fallback for old format #}
                        <div class="d-flex align-items-center mb-3">
                            {% if publication.author_image %}
                            <img src="{{ url_for('static', filename='uploads/authors/' + publication.author_image) }}" 
                                 class="author-avatar-large mr-3" alt="{{ publication.author }}">
                            {% else %}
                            <div class="author-avatar-large bg-light d-flex align-items-center justify-content-center mr-3">
                                <i class="fas fa-user text-muted fa-2x"></i>
                            </div>
                            {% endif %}
                            <div>
                                <h6 class="mb-0 font-weight-bold">{{ publication.author }}</h6>
                                <small class="text-muted">Research Author</small>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div class="mb-4">
                    <div class="small text-muted mb-1 text-uppercase font-weight-bold">Category</div>
                    <span class="badge badge-light px-3 py-2 rounded-pill border">{{ publication.category }}</span>
                </div>

                <div class="mb-4">
                    <div class="small text-muted mb-1 text-uppercase font-weight-bold">Publish Date</div>
                    <div class="font-weight-medium"><i class="far fa-calendar-alt mr-2 text-primary"></i>{{ publication.publish_date | format_date }}</div>
                </div>

                <div class="mb-4">
                    <div class="small text-muted mb-1 text-uppercase font-weight-bold">Document Stats</div>
                    <div class="d-flex gap-3">
                        <span class="small mr-3"><i class="far fa-eye mr-1"></i> {{ publication.view_count or 0 }} views</span>
                        <span class="small"><i class="fas fa-file-pdf mr-1 text-danger"></i> PDF Document</span>
                    </div>
                </div>

                <hr>
                
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary btn-block rounded-pill font-weight-bold">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Gallery
                </a>
            </div>
        </div>

        <!-- PDF Viewer -->
        <div class="col-lg-9">
            <div class="viewer-container">
                <!-- Custom Toolbar -->
                <div class="viewer-toolbar">
                    <div class="toolbar-group">
                        <button id="prev" class="btn-viewer" title="Previous Page">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="page-counter">
                            Page <span id="page_num">0</span> of <span id="page_count">0</span>
                        </div>
                        <button id="next" class="btn-viewer" title="Next Page">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div class="toolbar-group">
                        <button id="zoom_out" class="btn-viewer" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <span id="zoom_percent" class="small">100%</span>
                        <button id="zoom_in" class="btn-viewer" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>

                    <div class="toolbar-group">
                        <button id="dual_page" class="btn-viewer text-info" title="Toggle Single Page View">
                            <i class="fas fa-book-open"></i> <span class="d-none d-sm-inline ml-1">Book Mode</span>
                        </button>
                        <a href="{{ pdf_url }}" download class="btn-viewer" title="Download Document">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>

                <!-- Canvas Area for Book Mode -->
                <div id="pdf-canvas-container">
                    <div id="loading-spinner" class="text-white text-center">
                        <div class="spinner-border mb-3" role="status"></div>
                        <h5>Opening document...</h5>
                    </div>
                    <canvas id="canvas-left" class="pdf-page-canvas d-none"></canvas>
                    <canvas id="canvas-right" class="pdf-page-canvas d-none"></canvas>
                </div>

                <!-- Scroll Area for Single Page Mode -->
                <div id="pdf-scroll-container" class="d-none">
                    <div id="loading-spinner-scroll" class="text-white text-center py-5">
                        <div class="spinner-border mb-3" role="status"></div>
                        <h5>Opening document...</h5>
                    </div>
                    <div id="scroll-pages" class="pdf-scroll-pages"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    const url = '{{ pdf_url }}';
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null,
        pageNum = 1,
        pageRendering = false,
        pageNumPending = null,
        scale = 1.0,
        isDualPage = true, // Default to dual page (book mode)
        isScrollMode = false;

    const canvasLeft = document.getElementById('canvas-left');
    const ctxLeft = canvasLeft.getContext('2d');
    const canvasRight = document.getElementById('canvas-right');
    const ctxRight = canvasRight.getContext('2d');

    /**
     * Render all pages for scroll mode
     */
    async function renderAllPagesForScroll() {
        document.getElementById('loading-spinner-scroll').classList.add('d-none');
        const scrollContainer = document.getElementById('scroll-pages');
        scrollContainer.innerHTML = ''; // Clear existing pages

        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });

            const canvas = document.createElement('canvas');
            canvas.className = 'scroll-page-canvas';
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const ctx = canvas.getContext('2d');
            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            await page.render(renderContext).promise;
            scrollContainer.appendChild(canvas);
        }
    }

    /**
     * Render a specific page to a specific canvas
     */
    async function renderPage(num, canvas, ctx) {
        pageRendering = true;
        const page = await pdfDoc.getPage(num);
        
        const viewport = page.getViewport({ scale: scale });
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };
        const renderTask = page.render(renderContext);

        await renderTask.promise;
        canvas.classList.remove('d-none');
        pageRendering = false;

        if (pageNumPending !== null) {
            renderPages(pageNumPending);
            pageNumPending = null;
        }
    }

    /**
     * Coordinate rendering of one or two pages
     */
    async function renderPages() {
        document.getElementById('loading-spinner').classList.add('d-none');
        
        // Hide right canvas initially
        canvasRight.classList.add('d-none');
        
        // Render left page (Current page)
        await renderPage(pageNum, canvasLeft, ctxLeft);

        // If dual page mode and there is a next page
        if (isDualPage && pageNum < pdfDoc.numPages) {
            await renderPage(pageNum + 1, canvasRight, ctxRight);
        }

        // Update page counters
        document.getElementById('page_num').textContent = isDualPage && pageNum < pdfDoc.numPages 
            ? `${pageNum}-${pageNum + 1}` 
            : pageNum;
        
        // Update button states
        document.getElementById('prev').disabled = pageNum <= 1;
        document.getElementById('next').disabled = isDualPage 
            ? pageNum >= pdfDoc.numPages - 1 
            : pageNum >= pdfDoc.numPages;
    }

    /**
     * Navigation
     */
    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum = isDualPage ? Math.max(1, pageNum - 2) : pageNum - 1;
        renderPages();
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum = isDualPage ? Math.min(pdfDoc.numPages, pageNum + 2) : pageNum + 1;
        renderPages();
    }

    /**
     * Zooming
     */
    function zoomIn() {
        scale += 0.2;
        updateZoom();
    }

    function zoomOut() {
        if (scale <= 0.4) return;
        scale -= 0.2;
        updateZoom();
    }

    function updateZoom() {
        document.getElementById('zoom_percent').textContent = `${Math.round(scale * 100)}%`;

        if (isScrollMode) {
            renderAllPagesForScroll();
        } else {
            renderPages();
        }
    }

    /**
     * Toggle between Book Mode and Scroll Mode
     */
    function toggleDualPage() {
        isDualPage = !isDualPage;
        isScrollMode = !isDualPage; // When not dual page, we're in scroll mode

        const btn = document.getElementById('dual_page');
        const bookContainer = document.getElementById('pdf-canvas-container');
        const scrollContainer = document.getElementById('pdf-scroll-container');

        const toolbar = document.querySelector('.viewer-toolbar');

        if (isDualPage) {
            // Book mode (dual page)
            btn.classList.add('text-info');
            btn.title = 'Switch to Scroll View';
            btn.innerHTML = '<i class="fas fa-book-open"></i> <span class="d-none d-sm-inline ml-1">Book Mode</span>';

            bookContainer.classList.remove('d-none');
            bookContainer.classList.remove('single-page');
            scrollContainer.classList.add('d-none');
            toolbar.classList.remove('has-scroll-mode');

            if (pageNum % 2 === 0 && pageNum > 1) pageNum--; // Ensure start on odd page for books
            renderPages();
        } else {
            // Scroll mode (single continuous page)
            btn.classList.remove('text-info');
            btn.title = 'Switch to Book View';
            btn.innerHTML = '<i class="fas fa-scroll"></i> <span class="d-none d-sm-inline ml-1">Scroll Mode</span>';

            bookContainer.classList.add('d-none');
            scrollContainer.classList.remove('d-none');
            toolbar.classList.add('has-scroll-mode');

            renderAllPagesForScroll();
        }
    }

    // Load PDF
    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('page_count').textContent = pdfDoc.numPages;

        if (isDualPage) {
            // Start in book mode
            document.getElementById('dual_page').classList.add('text-info');
            renderPages();
        } else {
            // Start in scroll mode
            document.getElementById('pdf-canvas-container').classList.add('d-none');
            document.getElementById('pdf-scroll-container').classList.remove('d-none');
            renderAllPagesForScroll();
        }
    });

    // Event Listeners
    document.getElementById('prev').addEventListener('click', onPrevPage);
    document.getElementById('next').addEventListener('click', onNextPage);
    document.getElementById('zoom_in').addEventListener('click', zoomIn);
    document.getElementById('zoom_out').addEventListener('click', zoomOut);
    document.getElementById('dual_page').addEventListener('click', toggleDualPage);

    // Keyboard navigation
    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') onPrevPage();
        if (e.key === 'ArrowRight') onNextPage();
    });
</script>
{% endblock %}
